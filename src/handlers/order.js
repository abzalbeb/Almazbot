const { Markup } = require('telegraf');
const diamonds = require('../config/diamonds');
const axios = require('axios');

module.exports = function registerOrderActions(bot) {
  const ADMIN_CHANNEL_ID = parseInt(process.env.ADMIN_CHANNEL_ID, 10);

  // 1. Almaz tanlash va Game ID + Zone ID so‚Äòrash
  bot.action(/order_\d+/, async (ctx) => {
    try {
      await ctx.answerCbQuery();
      const index = Number(ctx.match[0].split('_')[1]);
      const selected = diamonds[index];

      if (!selected) {
        return ctx.reply('‚ùå Noto‚Äòg‚Äòri tanlov.');
      }

      ctx.session = ctx.session || {};
      ctx.session.tempOrder = { ...selected };
      ctx.session.step = 'awaiting_full_id';

      await ctx.reply(
        `Iltimos, *Game ID* va *Zone ID* ni quyidagi formatda kiriting:\n\nüìå \`123456789 (1234)\`\n\n‚ö†Ô∏è *Server ID‚Äôsini unutmang!*`,
        { parse_mode: 'Markdown' }
      );
    } catch (err) {
      console.error('‚ùå order_x actionda xatolik:', err);
      ctx.reply('‚ùå Buyurtma bosqichida xatolik yuz berdi.');
    }
  });


  // 2. Game ID + Zone ID kiritish va Codashop orqali nickname olish
  bot.on('text', async (ctx) => {
    ctx.session = ctx.session || {};
    const input = ctx.message.text.trim();


    if (ctx.session.step === 'awaiting_full_id') {
      const match = input.match(/^(\d{5,15})\s*\((\d{2,6})\)$/);

      if (!match) {
        console.log('‚ùóÔ∏èFormat xato:', input);
        return ctx.reply(
          '‚ùå Format noto‚Äòg‚Äòri. Iltimos, *Game ID* va *Zone ID* ni quyidagi formatda yuboring:\n\nüìå `476595202 (2451)`',
          { parse_mode: 'Markdown' }
        );
      }

      const gameId = match[1];
      const zoneId = match[2];


      const payload = {
        country: 'sg',
        voucherTypeName: 'MOBILE_LEGENDS',
        whiteLabelId: '',
        userId: gameId,
        zoneId: zoneId,
        deviceId: '8afcdd63-fee2-4c6b-8a07-4c0efdfd5efa'
      };

      const headers = {
        'Content-Type': 'application/json',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N)',
        'Origin': 'https://www.codashop.com',
        'Referer': 'https://www.codashop.com/id-id/mobile-legends'
      };

      try {

        const response = await axios.post(
          'https://order-sg.codashop.com/validate/',
          payload,
          { headers }
        );



        const nickname = response.data?.result?.username;

        if (!nickname) {
          console.log('‚ùå Nickname topilmadi:', response.data);
          return ctx.reply('‚ùå O‚Äòyinchi topilmadi. Iltimos, Game ID va Zone ID ni tekshirib, qayta yuboring.');
        }

        // ‚úÖ Nickname chiqdi
        ctx.session.tempOrder.gameId = gameId;
        ctx.session.tempOrder.zoneId = zoneId;
        ctx.session.tempOrder.nickname = nickname;
        
        ctx.session.step = 'awaiting_confirmation';



        return ctx.reply(
          `üîç Topilgan nickname: *${nickname}*\n\nBu sizmisiz?\n\nüì¶ *Buyurtma tafsilotlari:*\n- üíé Almaz: ${ctx.session.tempOrder.amount} ta\n- üéÆ Game ID: \`${gameId}\`\n- üåê Zone ID: \`${zoneId}\``,
          {
            parse_mode: 'Markdown',
            ...Markup.inlineKeyboard([
              [Markup.button.callback('‚úÖ Ha, tasdiqlayman', 'confirm_order')],
              [Markup.button.callback('‚úèÔ∏è Ma\'lumotlarni o‚Äòzgartirish', 'edit_order')]
            ])
          }
        );
      } catch (error) {
        console.error('‚ùå Codashop nickname olishda xatolik:', error.response?.data || error.message);
        return ctx.reply('‚ùå Server bilan bog‚Äòlanishda xatolik yuz berdi. Keyinroq urinib ko‚Äòring.');
      }
    }

    if (ctx.session.step === 'awaiting_receipt') {
      console.log('üßæ Chek kutilyapti ‚Äì bu bosqich uchun boshqa handler ishlaydi.');
      return;
    }
  });



  // 3. To‚Äòlov usulini tanlash
  bot.action('confirm_order', async (ctx) => {
    await ctx.answerCbQuery();
    ctx.session = ctx.session || {};

    if (
      !ctx.session.tempOrder ||
      !ctx.session.tempOrder.gameId ||
      !ctx.session.tempOrder.zoneId
    ) {
      return ctx.reply('‚ùå Buyurtma ma‚Äôlumotlari topilmadi. Iltimos, qaytadan urinib ko‚Äòring.');
    }

    ctx.session.order = { ...ctx.session.tempOrder };
    ctx.session.tempOrder = null;
    ctx.session.step = null;

    const { amount, gameId, zoneId, nickname } = ctx.session.order;

    await ctx.reply(
      `üì• Buyurtmangiz tasdiqlandi:\n\n- üíé Almaz: ${amount} ta\n- üéÆ Game ID: \`${gameId}\`\n- üåê Zone ID: \`${zoneId}\`\n- üë§ Nickname: *${nickname}*\n\n‚è≥ Iltimos, to‚Äòlov usulini tanlang.`,
      {
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard([
          [Markup.button.callback('üí≥ Karta orqali to‚Äòlov', 'pay_by_card')]
        ])
      }
    );
  });


  // 4. Karta orqali to‚Äòlov ‚Üí kompaniya kartasi + "Men to‚Äòlovni amalga oshirdim" tugmasi
  bot.action('pay_by_card', async (ctx) => {
    await ctx.answerCbQuery();

        await ctx.reply(
          `üí≥ *Bizning karta ma'lumotlari:*

      1. *Uzcard*  
        ‚îî üí≥ Karta raqami: \`5614 6819 0618 7046\`  
        ‚îî üë§ Egasi: *BAXODIROV ISLOMBEK*

      2. *Uzum Visa*  
        ‚îî üí≥ Karta raqami: \`4916 9903 1534 5592\`  
        ‚îî üë§ Egasi: *ISLOMBEK BAXODIROV*`,
      {
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard([
          [Markup.button.callback('‚úÖ Men to‚Äòlovni amalga oshirdim', 'paid_confirm')]
        ])
      }
    );
  });

  // 5. "Men to‚Äòlovni amalga oshirdim" ‚Üí kvitansiya rasmini so‚Äòrash
  bot.action('paid_confirm', async (ctx) => {
    await ctx.answerCbQuery();
    ctx.session.step = 'awaiting_receipt';
    await ctx.reply('üñºÔ∏è Iltimos, to‚Äòlov kvitansiya screenshot rasmini yuboring.');
  });


  // 1) Photo yoki document kelganda
  bot.on(['photo', 'document'], async (ctx) => {
    if (ctx.session.step !== 'awaiting_receipt') return;

    // ‚õî Ruxsat berilganidan keyin boshqa rasm yuborishni bloklash
    if (ctx.session.receiptReceived) {
      return ctx.reply('‚ùå Siz allaqachon rasm yubordingiz. Iltimos, kuting.');
    }

    if (ctx.message.media_group_id) {
      return ctx.reply('‚ùå Iltimos, rasmni albom (guruh) sifatida emas, *alohida* yuboring.', {
        parse_mode: 'Markdown'
      });
    }

    let fileId;

    if (ctx.message.photo) {
      fileId = ctx.message.photo.at(-1).file_id;
    } else if (ctx.message.document) {
      const mime = ctx.message.document.mime_type;
      if (!mime.startsWith('image/')) {
        return ctx.reply('‚ùå Iltimos, faqat rasm fayli yuboring.');
      }
      fileId = ctx.message.document.file_id;
    }

    if (!fileId) {
      return ctx.reply('‚ùå Rasm topilmadi.');
    }

    // ‚úÖ Shu yerdan keyin boshqa rasmni qabul qilmasligi uchun flag o‚Äòrnatamiz
    ctx.session.receiptReceived = true;
    

    // Buyurtma ma‚Äôlumotlarini olish
    const { amount, gameId, zoneId, nickname} = ctx.session.order;
    const firstName = ctx.from.first_name || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π';
    const username = ctx.from.username ? `@${ctx.from.username}` : 'Username –Ω–µ—Ç';
    const userId = ctx.from.id;


    // Admin kanaliga yuborish
        await bot.telegram.sendPhoto(process.env.ADMIN_CHANNEL_ID, fileId, {
          caption:
            `üÜï *–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:*\n` +
            `- üíé –ê–ª–º–∞–∑—ã: ${amount} —à—Ç.\n` +
            `- üéÆ Game ID: \`${gameId}\`\n` +
            `- üåê Zone ID: \`${zoneId}\`\n` +
            `- üî∞ MLBB nickname: \`${nickname}\`\n` +
            `- üë§ –¢–ì –ò–º—è: ${firstName}\n` +
            `- üÜî –¢–ì Username: ${username}\n` +
            `- üßæ Telegram ID: \`${userId}\``,
          parse_mode: 'Markdown',
          ...Markup.inlineKeyboard([
            [
              Markup.button.callback('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', `approve_${userId}`),
              Markup.button.callback('‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å', `reject_${userId}`)
            ]
          ])
        });


    // ‚ùå Sessionni butunlay o‚Äòchirib tashlaymiz
    ctx.session = null;
    console.log(`Session foydalanuvchi uchun tozalandi: ${ctx.from.id}`);


    // Foydalanuvchiga javob
    await ctx.reply('üîé Adminlar ko‚Äòrib chiqmoqda. Tez orada javob beramiz.');
  });



  // // 4) ‚Äú‚úÖ Tasdiqlash‚Äù tugmasi bosilganda
  bot.action(/approve_(\d+)/, async (ctx) => {
    try {
      await ctx.answerCbQuery();
      const userId = Number(ctx.match[1]);
      const adminChatId = ctx.chat.id;
      const adminMsgId = ctx.update.callback_query.message.message_id;
      const origCaption = ctx.update.callback_query.message.caption || '';

      // Foydalanuvchiga xabar
      await bot.telegram.sendMessage(
        userId,
        '‚úÖ Buyurtmangiz tasdiqlandi!\n\n‚è≥ Almaz 1 daqiqadan 10 daqiqagacha hisobingizga tushadi. Tushganidan so‚Äòng bot orqali sizga xabar yuboriladi.'
      );


      // Xabarni yangilash (kanalda)
      await bot.telegram.editMessageCaption(
        adminChatId,
        adminMsgId,
        null,
        origCaption + '\n\n‚úÖ *Tasdiqlandi*',
        {
          parse_mode: 'Markdown',
          ...Markup.inlineKeyboard([
            [Markup.button.callback('üì• Almaz tushdi', `delivered_${userId}`)]
          ])
        }
      );
    } catch (error) {
      console.error('Tasdiqlash xatoligi:', error);
    }
  });


  // 5) ‚Äú‚ùå Atmen‚Äù tugmasi bosilganda
  bot.action(/reject_(\d+)/, async (ctx) => {
    try {
      await ctx.answerCbQuery();
      const userId = Number(ctx.match[1]);
      const adminChatId = ctx.chat.id;
      const adminMsgId = ctx.update.callback_query.message.message_id;
      const origCaption = ctx.update.callback_query.message.caption || '';

      // Foydalanuvchiga xabar
      await bot.telegram.sendMessage(
        userId,
        `‚ùå Afsus, buyurtmangiz hozircha *rad etildi*.\n\n` +
          `*Ehtimoliy sabablari:*\n` +
          `‚Ä¢ To‚Äòlov bizning hisobimizga tushmagan.\n` +
          `‚Ä¢ Yuborgan kvitansiyangizda aniqlik yetishmayapti yoki u haqiqiy emas.\n\n` +
          `üì© Iltimos, holatni aniqlashtirish uchun admin bilan bog‚Äòlaning.\n` +
          `‚ÄºÔ∏è Hozircha qayta to‚Äòlov QILMANG.`,
        {
          parse_mode: 'Markdown',
          ...Markup.inlineKeyboard([
            [Markup.button.callback('üõ† Tex. yordam', 'menu_support')]
          ])
        }
      );

      // Xabarni yangilash (kanalda)
      await bot.telegram.editMessageCaption(
        adminChatId,
        adminMsgId,
        null,
        origCaption + '\n\n‚ùå *Rad etildi*',
        { parse_mode: 'Markdown' }
      );
    } catch (error) {
      console.error('Rad etish xatoligi:', error);
    }
  });

  // ‚úÖ Almaz tushdi tugmasi bosilganda
  bot.action(/delivered_(\d+)/, async (ctx) => {
    try {
      await ctx.answerCbQuery();
      const userId = Number(ctx.match[1]);
      const adminChatId = ctx.chat.id;
      const adminMsgId = ctx.update.callback_query.message.message_id;
      const origCaption = ctx.update.callback_query.message.caption || '';

      // Foydalanuvchiga xabar
      await bot.telegram.sendMessage(
        userId,
        '‚úÖ Buyurtmangiz muvaffaqiyatli bajarildi!\n\nüíé Almazlar hisobingizga tushirildi.\n\nAgar xizmatimizdan mamnun bo‚Äòlsangiz ‚Äî iltimos, rasmiy kanalimizda fikr qoldiring. Bu bizga yanada yaxshiroq xizmat ko‚Äòrsatishda yordam beradi!\n\nüëá Fikr bildirish uchun quyidagi tugmani bosing.',
          Markup.inlineKeyboard([
            Markup.button.url('üìù Fikr qoldirish', 'https://t.me/MLStoreOfficial_chat/6')
          ])
      );

      // Xabarni yangilash (kanalda)
      await bot.telegram.editMessageCaption(
        adminChatId,
        adminMsgId,
        null,
        origCaption + '\n\nüì• *Almaz tushdi*',
        { parse_mode: 'Markdown' }
      );
    } catch (error) {
      console.error('Almaz tushdi bosilganda xatolik:', error);
    }
  });



  // Matn yuborsa xato chiqarsin
  bot.on('message', async (ctx) => {
    if (ctx.session?.step === 'awaiting_receipt') {
      if (!ctx.message.photo && !ctx.message.document) {
        return ctx.reply('‚ùå Iltimos, rasm yuboring . Matn yuborilmaydi.');
      }
    }
  });

  // 7. Ma'lumotlarni qayta kiritish
  bot.action('edit_order', async (ctx) => {
    await ctx.answerCbQuery();
    ctx.session.step = 'awaiting_full_id';
    await ctx.reply(
      `‚úèÔ∏è Yangi *Game ID* va *Zone ID* ni yuboring.\n\nüìå *Masalan:* \`123456789 (1234)\``,
      { parse_mode: 'Markdown' }
    );
  });
};